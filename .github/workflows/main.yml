name: CI

on:
  push:
    branches: [ main ]
#    tags: [ .* ]
#  pull_request:
#    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v2
      - name: Build project
        run: |
          echo "Building project..."
      - name: Extract version
        run: |
          version=$(cat gradle.properties | grep "version=" | awk -F'=' '{print $2}')
          echo "Setting env.project_version=$version"
          echo "project_version=$version" >> $GITHUB_ENV
      - name: Set perform release flag
        if: ${{ !endsWith(env.project_version, '-SNAPSHOT') }}
        run: |
          echo "Setting env.perform_release=true"
          echo "perform_release=true" >> $GITHUB_ENV
      - name: Wait for Maven Artifacts
        if: ${{ env.perform_release }}
        env:
          REPO: ${{ github.repository }}
          VERSION: ${{ env.project_version }}
        run: |
          echo "Performing release of $REPO@$VERSION."
          until curl -f -s https://repo1.maven.org/maven2/org/springframework/security/spring-security-core/$VERSION/ > /dev/null
          do
            sleep 30
            echo "."
          done
          echo "Artifacts for $REPO@$VERSION have been released to Maven Central."
      - name: Create GitHub Release
        if: ${{ env.perform_release }}
        env:
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          TOKEN: ${{ github.token }}
          VERSION: ${{ env.project_version }}
        run: |
          echo "Tagging and publishing $REPO@$VERSION release to GitHub."
          echo "./gradlew createGitHubRelease -PnextVersion=$VERSION -Pbranch=$BRANCH -PcreateRelease=true -PgitHubAccessToken=$TOKEN"
